name: "OIDC First Time Setup"

on:
  workflow_dispatch:
    inputs:
      confirm_setup:
        description: 'Type "SETUP" to confirm OIDC initial deployment'
        required: true
        type: string
      force_oidc_recreation:
        description: 'Force recreation of OIDC provider and role (ignores existing resources)'
        required: false
        type: boolean
        default: false

permissions:
  id-token: write
  contents: read

jobs:
  validate_confirmation:
    name: "Validate Setup Confirmation"
    runs-on: ubuntu-latest
    outputs:
      confirmed: ${{ steps.validate.outputs.confirmed }}
    steps:
      - name: Validate Confirmation
        id: validate
        run: |
          if [[ "${{ github.event.inputs.confirm_setup }}" == "SETUP" ]]; then
            echo "confirmed=true" >> $GITHUB_OUTPUT
            echo "‚úÖ OIDC setup confirmed. Proceeding with initial deployment..."
          else
            echo "confirmed=false" >> $GITHUB_OUTPUT
            echo "‚ùå Confirmation failed. You must type 'SETUP' to proceed."
            exit 1
          fi

  setup_oidc:
    name: "Setup OIDC Infrastructure"
    runs-on: ubuntu-latest
    needs: validate_confirmation
    if: ${{ needs.validate_confirmation.outputs.confirmed == 'true' }}
    outputs:
      oidc_role_arn: ${{ steps.tf_outputs.outputs.oidc_role_arn }}
      oidc_exists: ${{ steps.check_oidc.outputs.oidc_exists }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Create secrets files
        run: |
          # Create .initial_secrets file with temporary AWS credentials
          echo "${{ secrets.INITIAL_SECRETS_B64 }}" | base64 -d > .initial_secrets
          chmod 600 .initial_secrets
          
          # Create .secrets file with project configuration
          echo "${{ secrets.SECRETS_B64 }}" | base64 -d > .secrets
          chmod 600 .secrets

      - name: Load Initial Environment Variables
        run: |
          # Load temporary AWS credentials from .initial_secrets (filter out comments and empty lines)
          export $(grep -v '^#' .initial_secrets | grep -v '^$' | xargs)
          echo "AWS_ACCESS_KEY_ID=${TEMP_AWS_ACCESS_KEY_ID}" >> $GITHUB_ENV
          echo "AWS_SECRET_ACCESS_KEY=${TEMP_AWS_SECRET_ACCESS_KEY}" >> $GITHUB_ENV
          
          # Load project configuration from .secrets (filter out comments and empty lines)
          export $(grep -v '^#' .secrets | grep -v '^$' | xargs)
          echo "AWS_REGION=${AWS_REGION}" >> $GITHUB_ENV
          echo "AWS_ACCOUNT_ID=${AWS_ACCOUNT_ID}" >> $GITHUB_ENV
          echo "TF_VAR_PREFIX=${TF_VAR_PREFIX}" >> $GITHUB_ENV
          echo "GITHUB_ORG=${GITHUB_ORG}" >> $GITHUB_ENV
          echo "GITHUB_REPO=${GITHUB_REPO}" >> $GITHUB_ENV
          
          # Create terraform.tfvars for OIDC setup
          cat <<EOF > infra/1-oidc/terraform.tfvars
          prefix = "${TF_VAR_PREFIX}"
          github_org = "${GITHUB_ORG}"
          github_repo = "${GITHUB_REPO}"
          aws_region = "${AWS_REGION}"
          aws_account_id = "${AWS_ACCOUNT_ID}"
          EOF

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.6.0"

      - name: Configure AWS Credentials (Temporary)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ env.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ env.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify S3 Terraform State Bucket
        run: |
          BUCKET_NAME="${TF_VAR_PREFIX}-terraform-state-unique1029"
          echo "üîç Checking if S3 bucket exists: ${BUCKET_NAME}"
          
          if aws s3api head-bucket --bucket "${BUCKET_NAME}" 2>/dev/null; then
            echo "‚úÖ S3 bucket '${BUCKET_NAME}' exists and is accessible"
          else
            echo "‚ùå S3 bucket '${BUCKET_NAME}' does not exist or is not accessible"
            echo "üìñ Please create the bucket manually in AWS Console:"
            echo "   - Name: ${BUCKET_NAME}"
            echo "   - Region: ${AWS_REGION}"
            echo "   - Versioning: ENABLED"
            echo "   - Encryption: ENABLED (AES-256)"
            echo "   - Block all public access: YES"
            exit 1
          fi
        env:
          TF_VAR_PREFIX: ${{ env.TF_VAR_PREFIX }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Configure Terraform Backend
        working-directory: infra/1-oidc
        run: |
          # Configure S3 backend for Terraform state
          cat <<EOF > backend.tf
          terraform {
            backend "s3" {
              bucket = "${TF_VAR_PREFIX}-terraform-state-unique1029"
              key    = "oidc/terraform.tfstate"
              region = "${AWS_REGION}"
            }
          }
          EOF
        env:
          TF_VAR_PREFIX: ${{ env.TF_VAR_PREFIX }}
          AWS_REGION: ${{ env.AWS_REGION }}

      - name: Check for Existing OIDC Provider
        id: check_oidc
        run: |
          if [ "${{ github.event.inputs.force_oidc_recreation }}" == "true" ]; then
            echo "üîÑ Force recreation enabled - will recreate OIDC provider and role from scratch"
            echo "oidc_exists=false" >> $GITHUB_OUTPUT
            echo "oidc_provider_arn=" >> $GITHUB_OUTPUT
          else
            echo "üîç Checking if GitHub OIDC provider already exists in this AWS account..."
            
            GITHUB_PROVIDER_ARN=$(aws iam list-open-id-connect-providers \
              --query 'OpenIDConnectProviderList[?contains(Arn, `token.actions.githubusercontent.com`)].Arn' \
              --output text || echo "")
            
            if [ -n "${GITHUB_PROVIDER_ARN}" ] && [ "${GITHUB_PROVIDER_ARN}" != "None" ]; then
              echo "oidc_exists=true" >> $GITHUB_OUTPUT
              echo "oidc_provider_arn=${GITHUB_PROVIDER_ARN}" >> $GITHUB_OUTPUT
              echo "‚úÖ OIDC Provider already exists: ${GITHUB_PROVIDER_ARN}"
              echo "‚ÑπÔ∏è  This setup will reuse the existing provider and create only the project-specific role"
            else
              echo "oidc_exists=false" >> $GITHUB_OUTPUT
              echo "oidc_provider_arn=" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è  No OIDC provider found - will create both provider and role"
            fi
          fi

      - name: Cleanup Existing Resources (if force recreation)
        if: ${{ github.event.inputs.force_oidc_recreation == 'true' }}
        run: |
          echo "üßπ Force recreation enabled - cleaning up existing OIDC resources..."
          
          # Check and delete existing role
          ROLE_NAME="${TF_VAR_PREFIX}-github-deploy-role"
          if aws iam get-role --role-name "$ROLE_NAME" >/dev/null 2>&1; then
            echo "üóëÔ∏è  Deleting existing role: $ROLE_NAME"
            # Detach all policies first
            aws iam list-attached-role-policies --role-name "$ROLE_NAME" --query 'AttachedPolicies[].PolicyArn' --output text | \
              xargs -r -I {} aws iam detach-role-policy --role-name "$ROLE_NAME" --policy-arn {}
            # Delete the role
            aws iam delete-role --role-name "$ROLE_NAME"
            echo "‚úÖ Role deleted"
          else
            echo "‚ÑπÔ∏è  Role $ROLE_NAME does not exist"
          fi
          
          # Check and delete existing OIDC provider
          EXISTING_PROVIDER=$(aws iam list-open-id-connect-providers \
            --query 'OpenIDConnectProviderList[?contains(Arn, `token.actions.githubusercontent.com`)].Arn' \
            --output text 2>/dev/null || echo "")
          
          if [ -n "$EXISTING_PROVIDER" ] && [ "$EXISTING_PROVIDER" != "None" ]; then
            echo "üóëÔ∏è  Deleting existing OIDC provider: $EXISTING_PROVIDER"
            aws iam delete-open-id-connect-provider --open-id-connect-provider-arn "$EXISTING_PROVIDER"
            echo "‚úÖ OIDC provider deleted"
          else
            echo "‚ÑπÔ∏è  No existing OIDC provider found"
          fi
          
          echo "üßπ Cleanup complete - ready for fresh OIDC setup"
        env:
          TF_VAR_PREFIX: ${{ env.TF_VAR_PREFIX }}

      - name: Configure Terraform Variables for OIDC Detection
        run: |
          # Add OIDC detection variable to terraform.tfvars
          cat <<EOF >> infra/1-oidc/terraform.tfvars
          oidc_provider_exists = ${{ steps.check_oidc.outputs.oidc_exists }}
          existing_oidc_provider_arn = "${{ steps.check_oidc.outputs.oidc_provider_arn }}"
          EOF

      - name: Terraform Init & Apply (OIDC with Smart Detection)
        working-directory: infra/1-oidc
        run: |
          if [ "${{ steps.check_oidc.outputs.oidc_exists }}" == "true" ]; then
            echo "üîÑ OIDC Provider exists - creating only project-specific role..."
          else
            echo "üÜï Creating new OIDC provider and project-specific role..."
          fi
          
          terraform init -reconfigure
          terraform plan -var-file=terraform.tfvars
          terraform apply -auto-approve -var-file=terraform.tfvars

      - name: Retrieve OIDC Role ARN
        id: tf_outputs
        working-directory: infra/1-oidc
        run: |
          OIDC_ROLE_ARN=$(terraform output -raw github_deploy_role_arn)
          echo "oidc_role_arn=${OIDC_ROLE_ARN}" >> $GITHUB_OUTPUT
          echo "OIDC_ROLE_ARN=${OIDC_ROLE_ARN}" >> $GITHUB_ENV

      - name: Test OIDC Authentication
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ steps.tf_outputs.outputs.oidc_role_arn }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-OIDCTest

      - name: Verify OIDC Setup
        run: |
          echo "üß™ Testing OIDC authentication..."
          aws sts get-caller-identity
          echo "‚úÖ OIDC setup successful!"

  setup_summary:
    name: "OIDC Setup Summary"
    runs-on: ubuntu-latest
    needs: setup_oidc
    steps:
      - name: Generate Setup Summary
        run: |
          echo "## üéâ OIDC Setup Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ‚úÖ What was created:" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.force_oidc_recreation }}" == "true" ]; then
            echo "- **FORCE RECREATION ENABLED** - Cleaned up and recreated all resources" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub OIDC Provider: **RECREATED** (force recreation)" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Deployment Role: **RECREATED** (force recreation)" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.setup_oidc.outputs.oidc_exists }}" == "true" ]; then
            echo "- GitHub OIDC Provider: **DETECTED & REUSED** (already existed in AWS account)" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Deployment Role: **CREATED** for this repository" >> $GITHUB_STEP_SUMMARY
          else
            echo "- GitHub OIDC Provider: **CREATED** (new in AWS account)" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub Deployment Role: **CREATED** for this repository" >> $GITHUB_STEP_SUMMARY
          fi
          echo "- Trust relationship between GitHub Actions and AWS" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîë GitHub Role ARN:" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ needs.setup_oidc.outputs.oidc_role_arn }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üßπ Critical Next Steps (SECURITY CLEANUP):" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **IMMEDIATELY perform these security cleanup steps:**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. **Delete temporary AWS user:**" >> $GITHUB_STEP_SUMMARY
          echo "   - AWS Console ‚Üí IAM ‚Üí Users ‚Üí temp-setup-{prefix}-{date} ‚Üí Delete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "2. **Delete temporary GitHub secret:**" >> $GITHUB_STEP_SUMMARY
          echo "   - GitHub repo ‚Üí Settings ‚Üí Secrets ‚Üí \`INITIAL_SECRETS_B64\` ‚Üí Delete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "3. **Clean up local files:**" >> $GITHUB_STEP_SUMMARY
          echo "   - \`rm .initial_secrets\`" >> $GITHUB_STEP_SUMMARY
          echo "   - \`rm .initial_secrets.b64 .secrets.b64\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "4. **Keep only \`SECRETS_B64\` secret** in GitHub for all future deployments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üöÄ Ready for OIDC Deployments!" >> $GITHUB_STEP_SUMMARY
          echo "You can now use the \`deploy-with-oidc.yml\` workflow for secure, credential-free deployments." >> $GITHUB_STEP_SUMMARY